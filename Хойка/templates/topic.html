<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>{{.Topic.Title}}</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="nav-buttons">
                <a href="/">–§–æ—Ä—É–º</a>
                <a href="/news">–ù–æ–≤–æ—Å—Ç–∏</a>
                <a href="/support">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
            </div>
            {{if .Username}}
            <div class="user-panel">
                <span>{{.Username}}</span>
                <a href="/profile/{{.Username}}" class="profile-button">–ü—Ä–æ—Ñ–∏–ª—å</a>
                <form action="/logout" method="post" style="display: inline;">
                    <button type="submit">–í—ã–π—Ç–∏</button>
                </form>
            </div>
            {{else}}
            <div class="auth-buttons">
                <a href="/login" class="auth-button">–í–æ–π—Ç–∏</a>
                <a href="/register" class="auth-button">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            </div>
            {{end}}
        </div>
    </div>

    <div class="container">
        <div class="forum-section">
            <h1 class="topic-title">{{.Topic.Title}}</h1>
            <div class="topic-main-content">
                <p>{{.Topic.Content}}</p>
                <div class="topic-meta">
                    <span class="author">üë§ <a href="/profile/{{.Topic.Author}}" class="author-link">{{.Topic.Author}}</a></span> | 
                    <span class="date">üìÖ {{.Topic.CreatedAt}}</span>
                    <div class="reaction-buttons">
                        <button class="reaction-btn like {{if eq .Topic.UserReaction 1}}active{{end}}" 
                                onclick="handleReaction('topic', {{.Topic.ID}}, 1)">
                            üëç <span>{{.Topic.Likes}}</span>
                        </button>
                        <button class="reaction-btn dislike {{if eq .Topic.UserReaction -1}}active{{end}}" 
                                onclick="handleReaction('topic', {{.Topic.ID}}, -1)">
                            üëé <span>{{.Topic.Dislikes}}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="forum-section">
            <h2>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>
            {{range .Comments}}
            <div class="comment">
                <div class="comment-content">{{.Content}}</div>
                <div class="comment-meta">
                    <span class="author">üë§ <a href="/profile/{{.Author}}" class="author-link">{{.Author}}</a></span> | 
                    <span class="date">üìÖ {{.CreatedAt}}</span>
                    <div class="reaction-buttons">
                        <button class="reaction-btn like {{if eq .UserReaction 1}}active{{end}}" 
                                onclick="handleReaction('comment', {{.ID}}, 1)">
                            üëç <span>{{.Likes}}</span>
                        </button>
                        <button class="reaction-btn dislike {{if eq .UserReaction -1}}active{{end}}" 
                                onclick="handleReaction('comment', {{.ID}}, -1)">
                            üëé <span>{{.Dislikes}}</span>
                        </button>
                    </div>
                </div>
            </div>
            {{end}}

            {{if .Username}}
            <form action="/topic?id={{.Topic.ID}}" method="post" class="comment-form">
                <textarea name="content" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                <button type="submit">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </form>
            {{else}}
            <p class="login-prompt">üí° –ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="/login">–≤–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="/register">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a></p>
            {{end}}
        </div>
    </div>

    <script>
    function handleReaction(type, id, reaction) {
        if (!{{.Username}}) {
            window.location.href = '/login';
            return;
        }

        fetch('/reaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `type=${type}&id=${id}&reaction=${reaction}`
        }).then(() => {
            window.location.reload();
        });
    }
    </script>
</body>
</html>